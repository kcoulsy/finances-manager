// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum ContactStatus {
  PERSONAL
  ENQUIRY
  CLIENT
  SUPPLIER
}

enum ContactEngagement {
  ACTIVE
  INACTIVE
  SUSPENDED
}

model User {
  id                        String              @id @default(cuid())
  name                      String
  email                     String              @unique
  emailVerified             Boolean             @default(false)
  image                     String?
  createdAt                 DateTime            @default(now())
  updatedAt                 DateTime            @updatedAt
  accounts                  Account[]
  sessions                  Session[]
  userRoles                 UserRole[]
  projects                  Project[]
  projectUsers              ProjectUser[]
  projectInvitations        ProjectInvitation[] @relation("InvitationUser")
  invitedProjectInvitations ProjectInvitation[] @relation("InvitedByUser")
  notifications             Notification[]
  contacts                  Contact[]
  sentEmailLogs             EmailLog[]          @relation("SenderEmailLogs")
  receivedEmailLogs         EmailLog[]          @relation("RecipientEmailLogs")

  @@map("user")
}

model Role {
  id        String     @id @default(cuid())
  name      String     @unique
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  userRoles UserRole[]

  @@map("role")
}

model UserRole {
  id        String   @id @default(cuid())
  userId    String
  roleId    String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@map("user_role")
}

model Session {
  id        String   @id @default(cuid())
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id @default(cuid())
  accountId             String
  providerId            String
  userId                String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier, value])
  @@map("verification")
}

model Project {
  id                 String              @id @default(cuid())
  name               String
  description        String?
  userId             String
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  projectUsers       ProjectUser[]
  projectInvitations ProjectInvitation[]
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt

  @@index([userId])
  @@map("project")
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String
  subtitle  String?
  detail    String?
  link      String?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([userId, read])
  @@map("notification")
}

model Contact {
  id                 String             @id @default(cuid())
  userId             String
  user               User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  role               String? // 'Client', 'Contractor', 'Supplier', 'Team Member', 'Other'
  status             ContactStatus      @default(PERSONAL)
  engagement         ContactEngagement?
  firstName          String
  lastName           String
  email              String
  phoneMobile        String?
  phoneHome          String?
  phoneWork          String?
  notes              String?
  personalWebsite    String?
  linkedinUrl        String?
  twitterHandle      String?
  facebookUrl        String?
  instagramHandle    String?
  companyName        String?
  companyWebsite     String?
  vatNumber          String?
  registrationNumber String?
  accountsEmail      String?
  position           String? // Role/Position
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  deletedAt          DateTime?

  @@unique([userId, email])
  @@index([userId])
  @@index([userId, status])
  @@index([userId, engagement])
  @@index([email])
  @@map("contact")
}

enum AddressType {
  HOME
  WORK
  BILLING
  SHIPPING
  OTHER
}

model Address {
  id              String      @id @default(cuid())
  addressableType String // 'Contact' or 'Project' (polymorphic type)
  addressableId   String // ID of the related Contact or Project
  type            AddressType @default(OTHER)
  label           String?
  addressLine1    String
  addressLine2    String?
  locality        String?
  city            String
  county          String?
  postalCode      String
  country         String
  isPrimary       Boolean     @default(false)
  isActive        Boolean     @default(true)
  notes           String?
  metadata        String? // JSON string for additional metadata
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([addressableType, addressableId])
  @@index([isPrimary])
  @@index([isActive])
  @@map("address")
}

enum ProjectUserType {
  Client
  Contractor
  Employee
  Legal
}

model ProjectUser {
  id        String          @id @default(cuid())
  projectId String
  project   Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  userId    String
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  userType  ProjectUserType // Client, Contractor, Employee, Legal
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
  @@map("project_user")
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

model ProjectInvitation {
  id          String           @id @default(cuid())
  projectId   String
  project     Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  email       String // Email address to invite
  userId      String? // User ID if user already exists
  user        User?            @relation("InvitationUser", fields: [userId], references: [id], onDelete: Cascade)
  userType    ProjectUserType // Client, Contractor, Employee, Legal
  token       String           @unique // Invitation token for the link
  status      InvitationStatus @default(PENDING)
  expiresAt   DateTime // Invitation expiration date
  invitedById String // User ID who sent the invitation
  invitedBy   User             @relation("InvitedByUser", fields: [invitedById], references: [id], onDelete: Cascade)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  acceptedAt  DateTime?

  @@unique([projectId, email])
  @@index([projectId])
  @@index([email])
  @@index([token])
  @@index([status])
  @@map("project_invitation")
}

enum EmailLogStatus {
  SENT
  DELIVERED
  BOUNCED
  FAILED
}

model EmailLog {
  id                   String         @id @default(cuid())
  recipientEmail       String
  recipientUserId      String?
  recipientUser        User?          @relation("RecipientEmailLogs", fields: [recipientUserId], references: [id], onDelete: SetNull)
  recipientDisplayName String?
  senderEmail          String
  senderUserId         String?
  senderUser           User?          @relation("SenderEmailLogs", fields: [senderUserId], references: [id], onDelete: SetNull)
  senderDisplayName    String?
  subject              String
  content              String
  status               EmailLogStatus @default(SENT)
  mailType             String?
  mailClass            String?
  isResend             Boolean        @default(false)
  originalEmailLogId   String?
  originalEmailLog     EmailLog?      @relation("EmailLogResends", fields: [originalEmailLogId], references: [id], onDelete: SetNull)
  resends              EmailLog[]     @relation("EmailLogResends")
  errorMessage         String?
  sentAt               DateTime       @default(now())
  deliveredAt          DateTime?
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
  reads                EmailLogRead[]

  @@index([recipientEmail])
  @@index([senderEmail])
  @@index([recipientUserId])
  @@index([senderUserId])
  @@index([status])
  @@index([mailType])
  @@index([sentAt])
  @@index([isResend])
  @@index([originalEmailLogId])
  @@map("email_log")
}

model EmailLogRead {
  id              String   @id @default(cuid())
  emailLogId      String
  emailLog        EmailLog @relation(fields: [emailLogId], references: [id], onDelete: Cascade)
  readAt          DateTime @default(now())
  ipAddress       String?
  browser         String?
  operatingSystem String?

  @@index([emailLogId])
  @@index([readAt])
  @@map("email_log_read")
}
